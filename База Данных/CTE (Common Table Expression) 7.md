WITH –ó–∞–ø—Ä–æ—Å


## 1. ‚úÖ **–ß—Ç–æ —Ç–∞–∫–æ–µ CTE (`WITH`)**

**CTE (Common Table Expression)** ‚Äî —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏—Ä—É—é—à–∏–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö , –∫ –∫–æ—Ç–æ—Ä–æ–º—É –º–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö `SELECT`, `UPDATE`, `INSERT`, –∏ —Ç.–¥.

–í—ã—Ä–∞–∂–µ–Ω–∏–µ —Å WITH —Å—á–∏—Ç–∞–µ—Ç—Å—è "–≤—Ä–µ–º–µ–Ω–Ω—ã–º"  –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—å—Å—è –≥–¥–µ –ª–∏–±–æ –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –æ—Å–Ω–æ–≤–µ –≤ —Å—Ö–µ–º–µ –ë–î –¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞.

üìå –ü—Ä–∏–º–µ—Ä –æ–±—ã—á–Ω–æ–≥–æ CTE:

`WITH recent_orders AS (
   SELECT * FROM orders WHERE created_at > now() - INTERVAL '30 days' ) 
   SELECT * FROM recent_orders WHERE total > 1000;
   
   `

"–°–æ–∑–¥–∞–π –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `recent_orders`, –ø–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –∫–∞–∫ –æ–±—ã—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É."

- –ö–æ–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **—á–∏—Ç–∞–±–µ–ª—å–Ω–µ–µ** (–≤–º–µ—Å—Ç–æ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤).
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–æ–¥–∑–∞–ø—Ä–æ—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑**.


## üîÅ –ê —á—Ç–æ —Ç–∞–∫–æ–µ `RECURSIVE CTE`?

–≠—Ç–æ **—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ CTE**, –ø–æ–∑–≤–æ–ª—è—é—â–µ–µ –¥–µ–ª–∞—Ç—å **—Ä–µ–∫—É—Ä—Å–∏—é –≤ SQL**.

## ‚ùó –ü–æ—á–µ–º—É **–±–µ–∑ CTE –Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é**?

–ü–æ—Ç–æ–º—É —á—Ç–æ –æ–±—ã—á–Ω—ã–π SQL **–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∞–º–æ—Å—Å—ã–ª–∫–∏ –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞—Ö**.  
–¢—ã **–Ω–µ –º–æ–∂–µ—à—å –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–∞–º–æ–º—É —Å–µ–±–µ**.

`RECURSIVE CTE` ‚Äî —ç—Ç–æ **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±** —Å–∫–∞–∑–∞—Ç—å –±–∞–∑–µ:

> ¬´–í–æ—Ç –±–∞–∑–∞ —Ä–µ–∫—É—Ä—Å–∏–∏, –∞ —Ç–µ–ø–µ—Ä—å –ø–æ–≤—Ç–æ—Ä—è–π, –ø–æ–∫–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ¬ª.

## üìå –ë–µ–∑ `WITH RECURSIVE` —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ **–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ SQL**.

–¢—ã –Ω–µ –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å `SELECT ... FROM ... WHERE parent IN (—ç—Ç–æ—Ç –∂–µ SELECT)` ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Å—Å—ã–ª–∫–∞, –∏ –°–£–ë–î –Ω–µ –ø–æ–π–º—ë—Ç, –∫–∞–∫ –µ—ë –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å.



## üí¨ **–í–æ–ø—Ä–æ—Å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏:**

**"–ß—Ç–æ —Ç–∞–∫–æ–µ `WITH RECURSIVE` –≤ SQL? –ü—Ä–∏–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä, –≥–¥–µ –µ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –æ–±—ã—á–Ω—ã–º `JOIN`."**

### ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:**

**`WITH RECURSIVE`** ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –æ–ø–∏—Å–∞—Ç—å **—Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å** –≤ SQL, –≥–¥–µ —Ç–∞–±–ª–∏—Ü–∞ **—Å—Å—ã–ª–∞–µ—Ç—Å—è —Å–∞–º–∞ –Ω–∞ —Å–µ–±—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –∏–µ—Ä–∞—Ä—Ö–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –º–∞—Ä—à—Ä—É—Ç—ã –∏ —Ç.–¥.).


### üí¨ **1. –ú–æ–∂–µ—Ç –ª–∏ CTE –±—ã—Ç—å –æ–±–Ω–æ–≤–ª—è–µ–º—ã–º?**

üß† **–û—Ç–≤–µ—Ç:**  
–î–∞, –Ω–æ **–Ω–µ –≤—Å–µ–≥–¥–∞**.

- –ï—Å–ª–∏ CTE —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É **–±–µ–∑ `DISTINCT`, `GROUP BY`, `JOIN` –∏ —Ç.–¥.**, —Ç–æ –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å **–æ–±–Ω–æ–≤–ª—è–µ–º—ã–º**:

### üí¨ **3. –ö–∞–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É `RECURSIVE CTE` –ø–æ –≥–ª—É–±–∏–Ω–µ —Ä–µ–∫—É—Ä—Å–∏–∏?**

üß† **–û—Ç–≤–µ—Ç:**  
–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –°–£–ë–î.

- –í **PostgreSQL** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `max_recursive_depth = 100`